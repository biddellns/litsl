---

 - name: Include group vars
   include_vars:
      file: "../../group_vars/virtual_environment.yml"

 - name: Install minimum dependencies
   become: true
   apt: "name={{ item }} update_cache=yes state=installed"
   with_items:
              - python3-pip
              - python3-dev
              - libpq-dev
              - postgresql
              - postgresql-contrib
              - nginx
   tags: packages

 - name: Install mkvirtualenv
   become: true
   pip: "name={{ item }} executable=/usr/bin/pip3"
   with_items:
              - mkvirtualenv  

 - name: Add mkvirtualenv settings to .bashrc
   blockinfile:
      dest: ~/.bashrc
      insertafter: EOF
      block: | 
             export WORKON_HOME=$HOME/.virtualenvs
             export PROJECT_HOME=$HOME/Devel
             source /usr/local/bin/virtualenvwrapper.sh
      backup: yes    

 - name: Create virtual environment
   shell: "./usr/local/bin/virtualenvwrapper.sh && mkvirtualenv {{ venv_name }} --python={{ python_version }} --no-site-packages"
   args: 
      executable: /bin/bash
      creates: "{{ virtualenv_dir }}/{{ venv_name}}"
   register: mkvirtualenv
   failed_when: 'mkvirtualenv.changed and "New python executable" not found in mkvirtualenv.stdout'
